<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customer Care AI</title>
<style>
body {
  margin:0;
  background:#0f0f0f;
  font-family:Arial;
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.container {
  width:400px;
  background:#1c1c1c;
  padding:20px;
  border-radius:12px;
}
button {
  padding:10px 15px;
  background:#ff9800;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.chat {
  margin-top:15px;
  height:200px;
  overflow-y:auto;
  background:#111;
  padding:10px;
  border-radius:8px;
}
.user { color:#4caf50; }
.ai { color:#03a9f4; }
.system { color:#ff5722; }
</style>
</head>
<body>

<div class="container">
  <h3>Customer Care AI</h3>
  <button id="enableBtn">Enable Voice</button>
  <div class="chat" id="chat"></div>
</div>

<script>
const chatBox = document.getElementById("chat");

function addMessage(role,text){
  const d=document.createElement("div");
  d.className=role;
  d.innerText=text;
  chatBox.appendChild(d);
  chatBox.scrollTop=chatBox.scrollHeight;
}

let recognition;
let isEnabled=false;
let isSpeaking=false;

function supported(){
  return !!(window.SpeechRecognition||window.webkitSpeechRecognition);
}

async function enableVoice(){
  if(!supported()){
    addMessage("system","Speech recognition not supported.");
    return;
  }

  try{
    await navigator.mediaDevices.getUserMedia({audio:true});
  }catch{
    addMessage("system","Microphone permission denied.");
    return;
  }

  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  recognition=new SR();
  recognition.lang="en-AU";
  recognition.continuous=true;
  recognition.interimResults=false;

  recognition.onresult=async(event)=>{
    const text=event.results[event.results.length-1][0].transcript.trim();
    if(!text)return;

    recognition.stop();
    addMessage("user",text);

    let reply="Processing...";
    try{
      const res=await fetch("/api/chat",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({text})
      });
      const data=await res.json();
      reply=data.reply||"No response";
    }catch{
      reply="Chat API error.";
    }

    addMessage("ai",reply);
    speak(reply);
  };

  recognition.onend=()=>{
    if(isEnabled&&!isSpeaking){
      recognition.start();
    }
  };

  isEnabled=true;
  recognition.start();
  addMessage("system","Hands-free voice enabled.");
}

function speak(text){
  if(!("speechSynthesis"in window))return;

  isSpeaking=true;
  const utter=new SpeechSynthesisUtterance(text);
  utter.lang="en-AU";

  utter.onend=()=>{
    isSpeaking=false;
    if(isEnabled)recognition.start();
  };

  window.speechSynthesis.speak(utter);
}

document.getElementById("enableBtn").addEventListener("click",enableVoice);
</script>

</body>
</html>
